---
title: "6、文件服务器"
date: 2023-08-01T16:32:08+08:00
draft: false
---

存储是根本，先把存储搞定。  
思路是：一个单独的虚拟机(2C4G)作为数据存储服务器，直通两个机械硬盘(4T*2)作为存储，两个盘使用`mdadm`组Raid1，再部署一个NFS开放给其他机器使用，NFS也可以作为局域网内传文件和大文件上传服务器的手段。
<!--more-->

## 虚拟机
参见上一篇，不再详细说明了。


## 直通硬盘

在PVE的宿主机上执行以下命令
``` shell
# 查看硬盘的id
ls /dev/disk/by-id
qm set 100 -scsi1 /dev/disk/by-id/ata-WDC_WD42PURU-64C4CY0_WD-WXE2A23MPV30
qm set 100 -scsi2 /dev/disk/by-id/ata-WDC_WD42PURU-64C4CY0_WD-WXE2A23MPA7P
```

## 新硬盘组Raid1


``` shell
# 使用盘符的方式，每次重启盘符可能会漂移，组Raid会失败，机器启动也会失败，这种方式废弃了。
# mdadm -Cv /dev/md0 -n 2 -l 1 /dev/sdb /dev/sdc

# 注意，这个命令会擦除硬盘上的所有数据，谨慎执行！！！
mdadm -Cv /dev/md0 -n 2 -l 1 /dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_drive-scsi1 /dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_drive-scsi2

# 查看raid1的信息
mdadm -D /dev/md0

# 将盘符数据写进配置文件，raid配置重启自动生效
mdadm --detail --scan >> /etc/mdadm/mdadm.conf

# 这个要特别注意，每次修改完/etc/mdadm/mdadm.conf之后都要执行一次，具体可以参见自动生成的配置文件/etc/mdadm/mdadm.conf中的注释说明
update-initramfs -u

# 重启测试挂载情况
reboot
```


```
cat /etc/mdadm/mdadm.conf
```

``` txt
# mdadm.conf
#
# !NB! Run update-initramfs -u after updating this file.
# !NB! This will ensure that initramfs has an uptodate copy.
#
# Please refer to mdadm.conf(5) for information about this file.
#

# by default (built-in), scan all partitions (/proc/partitions) and all
# containers for MD superblocks. alternatively, specify devices to scan, using
# wildcards if desired.
#DEVICE partitions containers

# automatically tag new arrays as belonging to the local system
HOMEHOST <system>

# instruct the monitoring daemon where to send mail alerts
MAILADDR root

# definitions of existing MD arrays

# This configuration was auto-generated on Mon, 01 Apr 2024 06:57:36 +0000 by mkconf
DEVICE /dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_drive-scsi1 /dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_drive-scsi2
# 这行在上边的步骤中已经自动生成了，主要是上边这一行，实测其实没有也行
ARRAY /dev/md0 metadata=1.2 name=StorageServer:0 UUID=748c69ff:d6bc60de:0899c43e:88dab0a3 
```





## 重装系统恢复Raid1
apt install mdadm


-- 先尝试这个
``` shell
mdadm --assemble /dev/md0 /dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_drive-scsi1 /dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_drive-scsi2
```

-- 不行的话再尝试这个
``` shell
mdadm --create /dev/md0 --assume-clean --level=1 --verbose --raid-devices=2 /dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_drive-scsi1 /dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_drive-scsi2
```


``` shell
mdadm --detail --scan >> /etc/mdadm/mdadm.conf
update-initramfs -u
reboot
```

``` bash
vim /etc/fstab
```

```
/dev/md0 /data ext4 defaults 0 0
```


# 参考资料
https://www.dreamxu.com/debian-create-software-raid-one-arrays/


# 安装NFS服务
``` bash
apt install nfs-kernel-server
systemctl enable nfs-server
vim /etc/exports
```

```
/data 192.168.1.0/24(rw,sync,no_root_squash,no_subtree_check)
```

```
systemctl restart nfs-server
systemctl status nfs-server
```


## 客户端挂载NFS

``` bash
apt install nfs-common
vim /etc/fstab
```

```
192.168.1.201:/data /data nfs4 rw,nosuid 0 0
```

临时挂载命令
```
mount -t nfs4 192.168.1.201:/data /data
```