---
title: "1、什么是MQ以及为什么要用MQ"
date: 2021-11-18T09:56:42+08:00
draft: true
---

开个RocketMQ系列的文章，这是第一篇，聊一下什么是MQ以及为什么要用MQ，由于本人也不是什么专家所以文章里有什么错漏欢迎大家指出 `dongpo.li@hotmail.com`
<!--more-->

在进入主题之前我们先假设个场景：朋友来你家玩，大家开始喜闻乐见的娱乐活动：斗地主。

``` text
开局  
A: 对儿三
B: 对儿四
你: 等下哈,妈~帮我倒杯水.
妈妈: 好
你: 对儿圈儿
```

现实世界的场景映射到计算机问题的时候总是不能完全一致，但是还是可以辅助理解的。  
这里边在玩游戏的三个人就是主业务逻辑，你让妈妈倒水就是一次异步调用（试想如果是同步等待水倒好了你再出牌，是不是不太合理），因为倒水是个耗时操作，而且和斗地主关系不大。 

类似场景在互联网业务中有：
用户下单之后给用户发送短信（短信服务商一般不保证短信实时发送，用户下单之后页面就显示成功，用户等短信就行了，不然用户下单等到短信周页面才显示成功用户就睡着了）  
用户登录之后把用户一些信息发送给风控鉴别风险账号给版绑定手机号发短信  
用户领取某奖励与奖励到账  
...



这个情况在互联网业务场景会一些问题：
1. 项目里到处充斥着异步代码，我们都知道异步编程属于高级部分，代码质量和开发人员技术水平强相关，而且是特别容易出问题的，出问题不好排查且不好在测试重现。  
2. 业务高峰的时候，这种异步场景也是需要大量的机器支撑的，高峰一过这些机器也会进入闲置，资源浪费。  
3. 异步请求的后端服务异常了这次调用失败了需要重试不然数据不一致  

针对问题1，我们可以把这些异步请求进行一次封装，交给更专业的人维护，提供一个方法，让业务人员像同步方法一样调用。  
针对问题2，我们可以把异步请求的参数保存在一个地方，保存成功之后就给主业务线程返回成功，然后慢慢一个一个执行（所谓的削峰）执行失败之后重试。然后这种场景又不是特例，各处都要用到而且重试逻辑既复杂写起来又无聊还需要重复写，索性抽出来做成一个业务无关的单独服务。  

这时候，这次异步调用变成了：  
主业务（生产者）调用异步方法，通用业务（MQ）收到请求之后保存相关参数然后给业务返回成功，此时主业务逻辑继续，通用业务在合适的时间把参数发给能处理了这个参数的一个服务（消费者），消费者处理完之后通知MQ成功，否则MQ会在失败或一段时间没有收到消费者恢复之后重试。


